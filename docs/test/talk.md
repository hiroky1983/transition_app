# 会話練習（Talk）機能 テストケース仕様書

## 概要

本ドキュメントは、日本語-ベトナム語学習アプリの会話練習機能に特化したテストケースを定義します。Web 版（Next.js）と Mobile 版（React Native/Expo）の両プラットフォームにおける音声入力、AI 会話、UI 操作の詳細なテストシナリオを提供します。

## テスト対象機能

### 主要機能

1. **音声入力・認識機能**
2. **AI 会話機能（Gemini）**
3. **会話履歴管理**
4. **テキスト編集機能**
5. **音声再生機能**
6. **UI 状態管理**

### 技術スタック

- **Web**: MediaRecorder API, React Hook Form, useToast
- **Mobile**: Expo Audio, React Native Audio permissions
- **共通**: Google Speech-to-Text API, Google Gemini API

## 1. 初期表示・画面遷移テスト

### 1.1 画面初期表示テスト

#### Web 版

| テストケース    | 操作手順         | 期待結果                             |
| --------------- | ---------------- | ------------------------------------ |
| TALK-W-INIT-001 | /talk にアクセス | 「会話練習」タイトルが表示される     |
| TALK-W-INIT-002 | 初期状態の確認   | 会話履歴エリアが空で表示される       |
| TALK-W-INIT-003 | 入力エリアの確認 | 「音声入力を開始」ボタンが表示される |
| TALK-W-INIT-004 | ボタン状態の確認 | 送信ボタンが無効状態で表示される     |

#### Mobile 版

| テストケース    | 操作手順           | 期待結果                           |
| --------------- | ------------------ | ---------------------------------- |
| TALK-M-INIT-001 | 会話タブをタップ   | 会話練習画面が表示される           |
| TALK-M-INIT-002 | 画面レイアウト確認 | 会話エリアと入力エリアが適切に配置 |
| TALK-M-INIT-003 | 初期ボタン状態     | 「🎤 音声入力を開始」ボタンが表示  |

## 2. 音声入力・認識機能テスト

### 2.1 マイクアクセス許可テスト

#### Web 版

| テストケース   | 操作手順                           | 期待結果                                                   |
| -------------- | ---------------------------------- | ---------------------------------------------------------- |
| TALK-W-MIC-001 | 「音声入力を開始」ボタンをクリック | ブラウザのマイクアクセス許可ダイアログが表示               |
| TALK-W-MIC-002 | マイクアクセスを「許可」           | ボタンが「録音を停止」に変化、アイコンが StopCircle に変化 |
| TALK-W-MIC-003 | マイクアクセスを「拒否」           | 「マイクへのアクセスに失敗しました」トーストエラー表示     |
| TALK-W-MIC-004 | 2 回目以降のアクセス               | 許可済みの場合、即座に録音開始                             |

#### Mobile 版

| テストケース   | 操作手順               | 期待結果                                          |
| -------------- | ---------------------- | ------------------------------------------------- |
| TALK-M-MIC-001 | 音声入力ボタンをタップ | システムのマイクアクセス許可ダイアログが表示      |
| TALK-M-MIC-002 | 「OK」をタップ         | ボタンが「⏹️ 録音を停止」に変化、背景色が赤に変化 |
| TALK-M-MIC-003 | 「許可しない」をタップ | 「マイクへのアクセス許可が必要です」アラート表示  |
| TALK-M-MIC-004 | 設定からの権限変更     | アプリ再起動後、新しい権限設定が反映される        |

### 2.2 録音機能テスト

#### 正常系テスト

| テストケース | 操作手順                           | 期待結果                           |
| ------------ | ---------------------------------- | ---------------------------------- |
| TALK-REC-001 | 録音開始後、5 秒間ベトナム語で話す | 録音状態が維持される               |
| TALK-REC-002 | 録音中に「録音を停止」をクリック   | 「処理中...」状態に変化            |
| TALK-REC-003 | 音声認識完了                       | 認識結果がテキストフィールドに表示 |
| TALK-REC-004 | 認識後の状態変化                   | 1.5 秒後に編集モードに自動切り替え |

#### 異常系テスト

| テストケース   | 操作手順                            | 期待結果                                   |
| -------------- | ----------------------------------- | ------------------------------------------ |
| TALK-REC-E-001 | 無音状態で録音                      | 適切なエラーハンドリングまたは空の認識結果 |
| TALK-REC-E-002 | 非常に短い録音（1 秒未満）          | 「音声が短すぎます」等のメッセージ         |
| TALK-REC-E-003 | 非常に長い録音（5 分以上）          | 適切な制限またはタイムアウト処理           |
| TALK-REC-E-004 | 録音中にネットワーク切断            | 「音声入力の処理に失敗しました」エラー     |
| TALK-REC-E-005 | 録音中にページリロード（Web 版）    | 録音が適切に停止される                     |
| TALK-REC-E-006 | 録音中にアプリ切り替え（Mobile 版） | バックグラウンド処理が適切に動作           |

### 2.3 音声認識精度テスト

#### ベトナム語認識テスト

| テストケース | 入力音声                | 期待結果                          |
| ------------ | ----------------------- | --------------------------------- |
| TALK-STT-001 | "Xin chào"              | 「Xin chào」が認識される          |
| TALK-STT-002 | "Cảm ơn bạn"            | 「Cảm ơn bạn」が認識される        |
| TALK-STT-003 | "Tôi tên là Hiroki"     | 「Tôi tên là Hiroki」が認識される |
| TALK-STT-004 | 長い文章（20 単語以上） | 適切に認識される                  |

#### 日本語認識テスト

| テストケース | 入力音声               | 期待結果                             |
| ------------ | ---------------------- | ------------------------------------ |
| TALK-STT-005 | "こんにちは"           | 「こんにちは」が認識される           |
| TALK-STT-006 | "ありがとうございます" | 「ありがとうございます」が認識される |

#### 音質・環境テスト

| テストケース | 操作手順               | 期待結果                   |
| ------------ | ---------------------- | -------------------------- |
| TALK-STT-007 | 静かな環境での録音     | 高精度で認識される         |
| TALK-STT-008 | 騒音がある環境での録音 | ノイズフィルタリングが機能 |
| TALK-STT-009 | 小さな声での録音       | 適切な音量調整または警告   |
| TALK-STT-010 | 早口での録音           | 可能な限り正確に認識       |

## 3. テキスト編集機能テスト

### 3.1 編集モード切り替えテスト

#### Web 版

| テストケース    | 操作手順                               | 期待結果                                           |
| --------------- | -------------------------------------- | -------------------------------------------------- |
| TALK-W-EDIT-001 | 音声認識後の自動切り替え               | 1.5 秒後にテキスト入力フィールドが表示             |
| TALK-W-EDIT-002 | 編集ボタン（Edit2 アイコン）をクリック | 手動で編集モードに切り替わる                       |
| TALK-W-EDIT-003 | マイクボタンをクリック                 | 音声入力モードに戻る                               |
| TALK-W-EDIT-004 | 編集モード中の UI 確認                 | テキストフィールド、マイクボタン、送信ボタンが表示 |

#### Mobile 版

| テストケース    | 操作手順                   | 期待結果                       |
| --------------- | -------------------------- | ------------------------------ |
| TALK-M-EDIT-001 | 音声認識完了後             | 自動的に編集モードに切り替わる |
| TALK-M-EDIT-002 | 編集ボタン（✏️）をタップ   | 編集モードに切り替わる         |
| TALK-M-EDIT-003 | マイクボタン（🎤）をタップ | 音声入力モードに戻る           |
| TALK-M-EDIT-004 | キーボード表示時           | レイアウトが適切に調整される   |

### 3.2 テキスト編集操作テスト

#### 正常系テスト

| テストケース  | 操作手順                     | 期待結果                   |
| ------------- | ---------------------------- | -------------------------- |
| TALK-EDIT-001 | 認識結果を部分修正           | 修正内容が正しく反映される |
| TALK-EDIT-002 | 認識結果を全削除して新規入力 | 新しいテキストが入力される |
| TALK-EDIT-003 | 特殊文字の入力               | 特殊文字が正しく入力される |
| TALK-EDIT-004 | 絵文字の入力                 | 絵文字が正しく表示される   |
| TALK-EDIT-005 | 長文の入力（500 文字）       | 適切に入力・表示される     |

#### Mobile 版特有テスト

| テストケース    | 操作手順                       | 期待結果                   |
| --------------- | ------------------------------ | -------------------------- |
| TALK-M-EDIT-005 | 複数行テキストの入力           | multiline 対応で適切に表示 |
| TALK-M-EDIT-006 | テキスト選択・コピー・ペースト | ネイティブ機能が正常動作   |
| TALK-M-EDIT-007 | 自動補完機能                   | システムの自動補完が動作   |

### 3.3 バリデーションテスト

| テストケース   | 操作手順                     | 期待結果                   |
| -------------- | ---------------------------- | -------------------------- |
| TALK-VALID-001 | 空文字で送信ボタンをクリック | 送信ボタンが無効状態のまま |
| TALK-VALID-002 | 空白文字のみで送信           | 送信されない               |
| TALK-VALID-003 | 有効なテキスト入力後         | 送信ボタンが有効状態になる |

## 4. AI 会話機能テスト

### 4.1 メッセージ送信テスト

#### 正常系テスト

| テストケース | 操作手順                 | 期待結果                           |
| ------------ | ------------------------ | ---------------------------------- |
| TALK-AI-001  | "Xin chào"を送信         | ユーザーメッセージが会話履歴に追加 |
| TALK-AI-002  | AI 応答の確認            | AI からのベトナム語応答が表示      |
| TALK-AI-003  | 送信後のフォームリセット | 入力フィールドがクリアされる       |
| TALK-AI-004  | 編集モードの解除         | 音声入力モードに戻る               |

#### 異常系テスト

| テストケース  | 操作手順                   | 期待結果                                 |
| ------------- | -------------------------- | ---------------------------------------- |
| TALK-AI-E-001 | ネットワーク切断状態で送信 | 「メッセージの送信に失敗しました」エラー |
| TALK-AI-E-002 | API エラー時               | 適切なエラーメッセージが表示             |
| TALK-AI-E-003 | タイムアウト時             | タイムアウトエラーが表示                 |

### 4.2 AI 応答品質テスト

#### ベトナム語会話テスト

| テストケース   | 入力メッセージ            | 期待結果                   |
| -------------- | ------------------------- | -------------------------- |
| TALK-AI-VN-001 | "Xin chào"                | ベトナム語での挨拶応答     |
| TALK-AI-VN-002 | "Bạn có khỏe không?"      | 健康状態に関する適切な応答 |
| TALK-AI-VN-003 | "Tôi đang học tiếng Việt" | 学習に関する励ましの応答   |
| TALK-AI-VN-004 | "Cảm ơn bạn"              | 感謝に対する適切な応答     |

#### 日本語入力テスト

| テストケース   | 入力メッセージ       | 期待結果                       |
| -------------- | -------------------- | ------------------------------ |
| TALK-AI-JP-001 | "こんにちは"         | ベトナム語での応答             |
| TALK-AI-JP-002 | "ベトナム語を教えて" | ベトナム語学習に関する応答     |
| TALK-AI-JP-003 | "今日の天気はどう？" | ベトナム語での天気に関する応答 |

#### 会話継続性テスト

| テストケース     | 操作手順       | 期待結果               |
| ---------------- | -------------- | ---------------------- |
| TALK-AI-CONT-001 | 5 回連続で会話 | 文脈を考慮した応答     |
| TALK-AI-CONT-002 | 話題を変更     | 新しい話題に適切に対応 |
| TALK-AI-CONT-003 | 前の会話を参照 | 会話履歴を考慮した応答 |

## 5. 会話履歴管理テスト

### 5.1 メッセージ表示テスト

#### Web 版

| テストケース    | 操作手順                 | 期待結果               |
| --------------- | ------------------------ | ---------------------- |
| TALK-W-HIST-001 | ユーザーメッセージの表示 | 右寄せ、青背景で表示   |
| TALK-W-HIST-002 | AI メッセージの表示      | 左寄せ、白背景で表示   |
| TALK-W-HIST-003 | メッセージの順序         | 時系列順で正しく表示   |
| TALK-W-HIST-004 | 長いメッセージの表示     | 適切に改行・表示される |

#### Mobile 版

| テストケース    | 操作手順           | 期待結果                   |
| --------------- | ------------------ | -------------------------- |
| TALK-M-HIST-001 | ユーザーメッセージ | 右寄せ、青背景のバブル表示 |
| TALK-M-HIST-002 | AI メッセージ      | 左寄せ、白背景のバブル表示 |
| TALK-M-HIST-003 | メッセージ間隔     | 適切なマージンで表示       |
| TALK-M-HIST-004 | 画面幅での表示     | 最大 80%幅で表示           |

### 5.2 スクロール機能テスト

| テストケース    | 操作手順               | 期待結果                     |
| --------------- | ---------------------- | ---------------------------- |
| TALK-SCROLL-001 | 10 件のメッセージ交換  | スクロールバーが表示される   |
| TALK-SCROLL-002 | 新しいメッセージ追加時 | 自動的に最下部にスクロール   |
| TALK-SCROLL-003 | 手動スクロール         | 過去のメッセージが確認できる |
| TALK-SCROLL-004 | 長いメッセージでの表示 | 適切にスクロール領域が調整   |

### 5.3 メッセージ永続化テスト

| テストケース     | 操作手順                    | 期待結果                 |
| ---------------- | --------------------------- | ------------------------ |
| TALK-PERSIST-001 | ページリロード（Web 版）    | 会話履歴がリセットされる |
| TALK-PERSIST-002 | アプリ切り替え（Mobile 版） | 会話履歴が保持される     |
| TALK-PERSIST-003 | アプリ再起動（Mobile 版）   | 会話履歴がリセットされる |

## 6. 音声再生機能テスト

### 6.1 音声再生ボタンテスト

#### Web 版

| テストケース     | 操作手順                      | 期待結果                                        |
| ---------------- | ----------------------------- | ----------------------------------------------- |
| TALK-W-AUDIO-001 | AI メッセージの音声ボタン確認 | Volume2 アイコンのボタンが表示                  |
| TALK-W-AUDIO-002 | 音声ボタンをクリック          | コンソールに"Playing audio: [メッセージ]"が出力 |
| TALK-W-AUDIO-003 | ユーザーメッセージ            | 音声ボタンが表示されない                        |

#### Mobile 版

| テストケース     | 操作手順                  | 期待結果                                   |
| ---------------- | ------------------------- | ------------------------------------------ |
| TALK-M-AUDIO-001 | AI メッセージの音声ボタン | 🔊 アイコンのボタンが表示                  |
| TALK-M-AUDIO-002 | 音声ボタンをタップ        | 「音声再生機能は実装予定です」アラート表示 |
| TALK-M-AUDIO-003 | アラート内容確認          | メッセージ内容が含まれる                   |

### 6.2 音声再生機能拡張テスト（将来実装）

| テストケース          | 操作手順              | 期待結果                   |
| --------------------- | --------------------- | -------------------------- |
| TALK-AUDIO-FUTURE-001 | Text-to-Speech 実装後 | ベトナム語音声が再生される |
| TALK-AUDIO-FUTURE-002 | 音声品質確認          | 自然なベトナム語発音       |
| TALK-AUDIO-FUTURE-003 | 再生中の状態管理      | 再生中は他の音声が停止     |

## 7. UI 状態管理テスト

### 7.1 ボタン状態テスト

#### 録音状態管理

| テストケース   | 操作手順   | 期待結果                     |
| -------------- | ---------- | ---------------------------- |
| TALK-STATE-001 | 初期状態   | 「音声入力を開始」ボタン表示 |
| TALK-STATE-002 | 録音開始後 | 「録音を停止」ボタンに変化   |
| TALK-STATE-003 | 録音停止後 | 「処理中...」表示            |
| TALK-STATE-004 | 処理完了後 | 編集モードに切り替わり       |

#### 送信ボタン状態管理

| テストケース   | 操作手順       | 期待結果                               |
| -------------- | -------------- | -------------------------------------- |
| TALK-STATE-005 | テキストなし   | 送信ボタンが無効状態                   |
| TALK-STATE-006 | テキスト入力後 | 送信ボタンが有効状態                   |
| TALK-STATE-007 | 送信処理中     | 送信ボタンが無効状態                   |
| TALK-STATE-008 | 送信完了後     | 送信ボタンが無効状態（テキストクリア） |

### 7.2 フォーム状態管理

| テストケース  | 操作手順             | 期待結果                     |
| ------------- | -------------------- | ---------------------------- |
| TALK-FORM-001 | 音声認識結果の設定   | フォーム値が正しく設定される |
| TALK-FORM-002 | 手動テキスト編集     | フォーム値が更新される       |
| TALK-FORM-003 | フォームリセット     | 全ての値がクリアされる       |
| TALK-FORM-004 | バリデーションエラー | エラー状態が適切に表示       |

## 8. パフォーマンステスト

### 8.1 レスポンス時間テスト

| 機能            | 期待レスポンス時間 | 測定方法                       |
| --------------- | ------------------ | ------------------------------ |
| 音声認識処理    | < 5 秒             | 録音停止から結果表示まで       |
| AI 応答生成     | < 10 秒            | メッセージ送信から応答表示まで |
| UI 状態切り替え | < 100ms            | ボタンクリックから状態変化まで |
| 会話履歴表示    | < 200ms            | メッセージ追加から表示まで     |

### 8.2 メモリ使用量テスト

| テストケース  | 操作手順                  | 期待結果                   |
| ------------- | ------------------------- | -------------------------- |
| TALK-PERF-001 | 長時間の会話（50 回交換） | メモリリークが発生しない   |
| TALK-PERF-002 | 音声データの処理          | 適切にメモリが解放される   |
| TALK-PERF-003 | 会話履歴の蓄積            | メモリ使用量が適切な範囲内 |

### 8.3 ネットワーク使用量テスト

| テストケース | 操作手順       | 期待結果           |
| ------------ | -------------- | ------------------ |
| TALK-NET-001 | 音声データ送信 | 適切なデータサイズ |
| TALK-NET-002 | AI 応答受信    | 効率的なデータ転送 |
| TALK-NET-003 | 連続使用時     | 帯域幅の適切な使用 |

## 9. エラーハンドリングテスト

### 9.1 ネットワークエラーテスト

| テストケース     | 操作手順                     | 期待結果                                 |
| ---------------- | ---------------------------- | ---------------------------------------- |
| TALK-ERR-NET-001 | 音声送信中にネットワーク切断 | 「音声入力の処理に失敗しました」エラー   |
| TALK-ERR-NET-002 | AI 応答中にネットワーク切断  | 「メッセージの送信に失敗しました」エラー |
| TALK-ERR-NET-003 | 低速ネットワーク環境         | タイムアウト処理が適切に動作             |

### 9.2 API エラーテスト

| テストケース     | 操作手順                  | 期待結果                   |
| ---------------- | ------------------------- | -------------------------- |
| TALK-ERR-API-001 | Speech-to-Text API エラー | 適切なエラーメッセージ表示 |
| TALK-ERR-API-002 | Gemini API エラー         | 適切なエラーメッセージ表示 |
| TALK-ERR-API-003 | API レート制限            | 制限に関するメッセージ表示 |

### 9.3 デバイスエラーテスト

| テストケース     | 操作手順                   | 期待結果                       |
| ---------------- | -------------------------- | ------------------------------ |
| TALK-ERR-DEV-001 | マイクが接続されていない   | 適切なエラーメッセージ         |
| TALK-ERR-DEV-002 | マイクが他のアプリで使用中 | 競合に関するエラーメッセージ   |
| TALK-ERR-DEV-003 | 音声入力デバイスの故障     | ハードウェアエラーの適切な処理 |

## 10. セキュリティテスト

### 10.1 音声データセキュリティ

| テストケース | 操作手順               | 期待結果                   |
| ------------ | ---------------------- | -------------------------- |
| TALK-SEC-001 | 音声データの送信       | HTTPS 通信で暗号化される   |
| TALK-SEC-002 | 音声データの保存       | ローカルに永続保存されない |
| TALK-SEC-003 | 音声データのキャッシュ | 適切にクリアされる         |

### 10.2 入力値検証

| テストケース | 操作手順                 | 期待結果             |
| ------------ | ------------------------ | -------------------- |
| TALK-SEC-004 | 悪意のあるスクリプト入力 | サニタイズされて表示 |
| TALK-SEC-005 | 大容量テキスト入力       | 適切な制限が適用     |
| TALK-SEC-006 | 特殊文字の大量入力       | 適切に処理される     |

## 11. アクセシビリティテスト

### 11.1 キーボードナビゲーション

| テストケース  | 操作手順               | 期待結果           |
| ------------- | ---------------------- | ------------------ |
| TALK-A11Y-001 | Tab キーでの要素移動   | 論理的な順序で移動 |
| TALK-A11Y-002 | Enter キーでボタン操作 | 適切に動作する     |
| TALK-A11Y-003 | Space キーでボタン操作 | 適切に動作する     |

### 11.2 スクリーンリーダー対応

| テストケース  | 操作手順          | 期待結果                       |
| ------------- | ----------------- | ------------------------------ |
| TALK-A11Y-004 | aria-label の確認 | 「発音を聞く」等の適切なラベル |
| TALK-A11Y-005 | 状態変化の通知    | 録音状態の変化が読み上げられる |
| TALK-A11Y-006 | エラーメッセージ  | エラー内容が適切に伝わる       |

## 12. 互換性テスト

### 12.1 ブラウザ互換性（Web 版）

| ブラウザ | MediaRecorder 対応 | テスト項目   |
| -------- | ------------------ | ------------ |
| Chrome   | ✓                  | 全機能テスト |
| Firefox  | ✓                  | 全機能テスト |
| Safari   | ✓                  | 全機能テスト |
| Edge     | ✓                  | 全機能テスト |

### 12.2 デバイス互換性（Mobile 版）

| デバイス | Audio API 対応 | テスト項目   |
| -------- | -------------- | ------------ |
| iPhone   | ✓              | 全機能テスト |
| Android  | ✓              | 全機能テスト |

## 13. 回帰テスト

### 13.1 リリース前チェックリスト

- [ ] 音声入力・認識機能の正常動作
- [ ] AI 会話機能の正常動作
- [ ] 会話履歴の正常表示
- [ ] エラーハンドリングの適切な動作
- [ ] 両プラットフォームでの動作確認
- [ ] パフォーマンス基準値の達成
- [ ] セキュリティテストの通過

### 13.2 自動テスト推奨項目

- API エンドポイント（/api/speech-to-text, /api/gemini）の応答確認
- 基本的な UI 要素の表示確認
- フォーム送信の動作確認
- エラーレスポンスの適切な処理

## 14. テスト実行ガイドライン

### 14.1 テスト環境準備

1. **サーバー起動確認**

   - FastAPI サーバーが起動している
   - Google Cloud API キーが設定されている
   - Gemini API キーが設定されている

2. **デバイス準備**

   - マイクが正常に動作する
   - 静かなテスト環境
   - 安定したネットワーク接続

3. **ブラウザ設定（Web 版）**
   - マイクアクセス許可の初期化
   - 開発者ツールでのネットワーク監視準備

### 14.2 テスト実行順序

1. 初期表示・画面遷移テスト
2. 音声入力・認識機能テスト
3. テキスト編集機能テスト
4. AI 会話機能テスト
5. 会話履歴管理テスト
6. UI 状態管理テスト
7. パフォーマンステスト
8. エラーハンドリングテスト

### 14.3 テスト結果記録

各テストケースについて以下を記録：

- テストケース ID
- 実行日時
- 実行環境（ブラウザ/デバイス）
- 結果（Pass/Fail）
- 備考（エラー内容、改善点等）

## 15. テスト完了基準

### 15.1 品質基準

- **正常系テスト**: 100% 通過
- **異常系テスト**: 95% 以上通過
- **パフォーマンステスト**: 全項目基準値内
- **セキュリティテスト**: 100% 通過
- **アクセシビリティテスト**: 90% 以上通過

### 15.2 リリース判定基準

- **致命的バグ**: 0 件（音声入力不可、AI 応答不可等）
- **重要バグ**: 2 件以下（UI 表示崩れ、軽微な機能不具合等）
- **軽微バグ**: 10 件以下（表示の微調整、文言修正等）
- **ユーザビリティ問題**: 5 件以下

### 15.3 特別考慮事項

- **音声認識精度**: 主要なベトナム語フレーズで 80%以上の認識率
- **AI 応答品質**: 文脈に適した自然なベトナム語応答
- **レスポンス時間**: ユーザーストレスを感じない応答速度
- **エラー回復**: エラー発生時の適切なユーザーガイダンス
